# Laravel Questionnaire Package - AI Coding Guidelines

You are an expert Laravel + Vue developer working on the `liangjin0228/questionnaire` package. This package is designed for **extreme extensibility**, **config-driven architecture**, and follows **SOLID principles** with **high cohesion and low coupling**.

---

## 1. Core Architecture Principles

### 1.1 SOLID Principles

| Principle | Application |
|-----------|-------------|
| **Single Responsibility (SRP)** | Each class has ONE reason to change. Actions do one thing. Controllers delegate to Actions. |
| **Open/Closed (OCP)** | Extend behavior via config, not code modification. Use interfaces for all extension points. |
| **Liskov Substitution (LSP)** | Custom implementations must honor interface contracts completely. |
| **Interface Segregation (ISP)** | Prefer small, focused interfaces over large ones. Split if >5 methods. |
| **Dependency Inversion (DIP)** | Depend on abstractions (Contracts), not concrete classes. |

### 1.2 Additional Principles

- **KISS (Keep It Simple, Stupid)**: Prefer simple, readable solutions over clever ones.
- **High Cohesion**: Related functionality stays together (e.g., all questionnaire logic in one module).
- **Low Coupling**: Modules communicate through interfaces, not direct dependencies.
- **Config-Driven**: Almost every class can be swapped via `config/questionnaire.php`.

---

## 2. Project Overview

- **Type**: Modular Laravel Package
- **PHP Version**: 8.2+
- **Strictness**: All PHP files MUST declare `declare(strict_types=1);`
- **Testing**: `./vendor/bin/phpunit`

---

## 3. Directory Structure

```text
src/
├── Console/                    # Artisan commands
├── Contracts/                  # ALL interfaces
│   └── Actions/               # Action interfaces (DIP compliance)
├── DTOs/                       # Data Transfer Objects - REQUIRED for Actions
├── Enums/                      # PHP Enums - NO MAGIC STRINGS
├── Events/                     # Domain events (*Creating, *Created, etc.)
├── Exceptions/                 # Custom exceptions
├── Export/                     # Export logic (CSV, Excel, etc.)
├── Guards/                     # Duplicate submission guards
├── Http/
│   ├── Controllers/           # Thin controllers - delegate to Actions
│   ├── Requests/              # Form requests with toDto() method
│   ├── Resources/             # API resources
│   └── Responses/             # Custom responsables
├── Listeners/                  # Event listeners
├── Mail/                       # Mailables
├── Managers/                   # Laravel Manager pattern implementations
├── Models/                     # Eloquent models (swappable via config)
├── Policies/                   # Authorization policies
├── QuestionTypes/              # Question type implementations
├── Repositories/               # Data access layer
├── Services/                   # Business logic Actions
└── Submission/                 # Response submission pipeline
    └── Pipes/                 # Pipeline processing steps

resources/js/questionnaire/     # Vue.js frontend
├── Components/                # Reusable UI components
│   └── QuestionTypes/        # Question type input components
├── Composables/               # Vue composables
├── Layouts/                   # Inertia layouts
├── Pages/                     # Inertia pages
├── Utils/                     # Helper utilities
├── index.js                   # Entry point
└── vuetify.js                 # Vuetify configuration
```

---

## 4. Backend Development Rules

### 4.1 Contracts (Interfaces)

**Rule**: Every swappable component MUST have an interface in `src/Contracts/`.

```php
// ✅ CORRECT: Interface for Action
namespace Liangjin0228\Questionnaire\Contracts\Actions;

interface CreateQuestionnaireActionInterface
{
    public function execute(QuestionnaireData $data, int|string|null $userId = null): Questionnaire;
}

// ✅ CORRECT: Implementation
class CreateQuestionnaireAction implements CreateQuestionnaireActionInterface
{
    public function __construct(
        protected QuestionnaireRepositoryInterface $repository  // Depend on interface
    ) {}
}
```

**Action Interfaces** (in `Contracts/Actions/`):
- `CreateQuestionnaireActionInterface`
- `UpdateQuestionnaireActionInterface`
- `PublishQuestionnaireActionInterface`
- `CloseQuestionnaireActionInterface`
- `SubmitResponseActionInterface`

### 4.2 DTOs (Data Transfer Objects)

**Rule**: NEVER pass raw arrays to Actions. ALWAYS use DTOs from `src/DTOs/`.

```php
// ❌ WRONG
$action->execute($request->validated(), $userId);

// ✅ CORRECT
$action->execute($request->toDto(), $userId);
```

**DTO Guidelines**:
- Use `spatie/laravel-data` as base
- Use strict Enum types, not strings
- Provide factory methods for backward compatibility (e.g., `fromStringType()`)
- Document all properties with PHPDoc

```php
class QuestionData extends Data
{
    public function __construct(
        #[WithCast(EnumCast::class)]
        public QuestionType $type,  // ✅ Enum, not string
        public string $content,
        public ?int $id = null,     // For update operations
    ) {}

    // Factory for backward compatibility
    public static function fromStringType(string $type, ...): self
    {
        return new self(type: QuestionType::from($type), ...);
    }
}
```

### 4.3 Enums

**Rule**: NEVER use magic strings. Use Enums from `src/Enums/`.

```php
// ❌ WRONG
if ($questionnaire->status === 'published') { ... }

// ✅ CORRECT
use Liangjin0228\Questionnaire\Enums\QuestionnaireStatus;

if ($questionnaire->status === QuestionnaireStatus::PUBLISHED->value) { ... }
```

**Available Enums**:
- `QuestionnaireStatus`: DRAFT, PUBLISHED, CLOSED, ARCHIVED
- `QuestionType`: TEXT, TEXTAREA, RADIO, CHECKBOX, SELECT, NUMBER, DATE

### 4.4 Models

**Rule**: NEVER hardcode model classes. Resolve from config.

```php
// ❌ WRONG
$questionnaire = new Questionnaire();

// ✅ CORRECT
$modelClass = config('questionnaire.models.questionnaire');
$questionnaire = new $modelClass();

// ✅ ALSO CORRECT (via Repository)
$questionnaire = $this->repository->create($data);
```

### 4.5 Dependency Injection

**Rule**: Inject interfaces, not concrete classes.

```php
// ❌ WRONG
public function __construct(
    protected CreateQuestionnaireAction $action  // Concrete class
) {}

// ✅ CORRECT
public function __construct(
    protected CreateQuestionnaireActionInterface $action  // Interface
) {}
```

**Infinite Recursion Fix**: When binding a class to itself via config:
```php
$this->app->bind(SomeInterface::class, function ($app) use ($binding) {
    $concrete = config('questionnaire.actions.some_key', $binding['default']);
    
    if ($concrete === $binding['default']) {
        return $app->build($binding['default']);  // ✅ Use build(), not make()
    }
    
    return $app->make($concrete);
});
```

### 4.6 Controllers

**Rule**: Controllers are THIN. They only:
1. Validate input (via FormRequest)
2. Convert to DTO
3. Delegate to Action
4. Return response

```php
public function store(StoreQuestionnaireRequest $request): RedirectResponse
{
    $questionnaire = $this->createAction->execute(
        $request->toDto(),              // DTO, not array
        $request->user()?->getKey()
    );

    return redirect()->route('questionnaire.admin.edit', $questionnaire);
}
```

### 4.7 Actions (Service Layer)

**Rule**: Actions encapsulate ONE business operation.

**Standard Action Pattern**:
```php
class CreateQuestionnaireAction implements CreateQuestionnaireActionInterface
{
    public function __construct(
        protected QuestionnaireRepositoryInterface $repository
    ) {}

    public function execute(QuestionnaireData $data, int|string|null $userId = null): Questionnaire
    {
        // 1. Fire "before" event
        event(new QuestionnaireCreating($data, $userId));

        // 2. Execute in transaction
        return DB::transaction(function () use ($data, $userId) {
            $questionnaire = $this->repository->create($this->prepareData($data, $userId));

            // 3. Handle related entities
            if ($data->hasQuestions()) {
                $this->createQuestions($questionnaire, $data->questions);
            }

            // 4. Fire "after" event
            event(new QuestionnaireCreated($questionnaire));

            return $questionnaire;
        });
    }
}
```

---

## 5. Extension Points

### 5.1 Config-Based Swapping

All major components can be swapped via `config/questionnaire.php`:

```php
// Models
'models' => [
    'questionnaire' => \App\Models\CustomQuestionnaire::class,
],

// Repositories
'bindings' => [
    'questionnaire_repository' => \App\Repositories\CustomRepository::class,
],

// Actions
'actions' => [
    'create_questionnaire' => \App\Actions\CustomCreateAction::class,
],

// Question Types
'question_types' => [
    \App\QuestionTypes\RatingQuestionType::class,
],
```

### 5.2 Custom Question Types

Implement `QuestionTypeInterface`:

```php
class RatingQuestionType extends AbstractQuestionType
{
    public function getIdentifier(): string
    {
        return 'rating';
    }

    public function getValidationRules(Question $question): array
    {
        return ['integer', 'min:1', 'max:5'];
    }

    public function getVueComponent(): string
    {
        return 'RatingInput';
    }
}
```

### 5.3 Custom Guards

Implement `DuplicateSubmissionGuardInterface`:

```php
class CustomGuard implements DuplicateSubmissionGuardInterface
{
    public function canSubmit(Questionnaire $questionnaire, Request $request): bool
    {
        // Custom logic
    }
}
```

---

## 6. Testing Protocols

### 6.1 Test Structure

```text
tests/
├── Feature/       # Integration tests (Action -> DB flow)
└── Unit/          # Isolated logic tests
```

### 6.2 Running Tests

```bash
./vendor/bin/phpunit
./vendor/bin/phpunit --testdox
./vendor/bin/phpunit --filter=CreateQuestionnaire
```

### 6.3 Test Guidelines

- Test interfaces, not implementations
- Mock dependencies via their interfaces
- Use `RefreshDatabase` trait for database tests

---

## 7. Frontend Development (Vue 3 + Inertia.js + Vuetify 3)

### 7.1 Technology Stack

| Technology | Purpose |
|------------|---------|
| **Vue 3** | UI framework with Composition API |
| **Inertia.js** | SPA routing via Laravel routes (NOT vue-router) |
| **Vuetify 3** | Material Design component library (NOT Tailwind) |
| **Vite** | Build tooling and dev server |
| **Pinia** | Application state management (if needed) |

### 7.2 Directory Structure

```text
resources/js/questionnaire/
├── Components/                # Reusable UI components
│   ├── QuestionTypes/        # Input components per question type
│   ├── Common/               # Shared components (Dialogs, Cards, etc.)
│   └── Form/                 # Form-related components
├── Composables/               # Vue composables (useForm, useQuestionnaire, etc.)
├── Layouts/                   # Inertia layouts (AdminLayout, PublicLayout)
├── Pages/                     # Inertia pages (mapped to Laravel routes)
│   ├── Admin/                # Admin pages
│   └── Public/               # Public-facing pages
├── Utils/                     # Helper utilities
├── index.js                   # Entry point (Inertia app initialization)
└── vuetify.js                 # Vuetify configuration
```

### 7.3 Component Design Standards

#### Single File Component Structure
```vue
<script setup lang="ts">
// 1. Imports
import { ref, computed, onMounted } from 'vue'
import { useForm } from '@inertiajs/vue3'

// 2. Props & Emits
const props = defineProps<{
  questionnaire: Questionnaire
  readonly?: boolean
}>()

const emit = defineEmits<{
  submit: [answers: Record<string, unknown>]
}>()

// 3. Composables
const { loading, error } = useAsyncState()

// 4. Reactive state
const formData = ref({})

// 5. Computed properties
const isValid = computed(() => /* ... */)

// 6. Methods
function handleSubmit() { /* ... */ }

// 7. Lifecycle hooks
onMounted(() => { /* ... */ })
</script>

<template>
  <!-- Use Vuetify components -->
  <v-card>
    <v-card-title>{{ questionnaire.title }}</v-card-title>
    <v-card-text>
      <slot />
    </v-card-text>
  </v-card>
</template>

<style scoped>
/* Component-specific styles only */
</style>
```

#### Component Design Rules
- **Single Responsibility**: One component = one concern
- **Naming**: PascalCase for components, kebab-case for files (`QuestionCard.vue`)
- **Size**: Keep components small (<200 lines); extract to composables if larger
- **Props**: Use TypeScript interfaces; validate with `defineProps<T>()`
- **Events**: Use typed `defineEmits<T>()`; prefer events over prop drilling

### 7.4 Routing with Inertia.js (NOT Vue Router)

**Rule**: Use Laravel routes via Inertia, NOT vue-router.

```vue
<script setup>
import { router } from '@inertiajs/vue3'

// ❌ WRONG - Do not use vue-router
// import { useRouter } from 'vue-router'

// ✅ CORRECT - Use Inertia router
function navigateToEdit(id) {
  router.visit(route('questionnaire.admin.edit', id))
}

// ✅ CORRECT - Use Inertia Link component
</script>

<template>
  <!-- ✅ CORRECT -->
  <Link :href="route('questionnaire.admin.index')">Dashboard</Link>
  
  <!-- ✅ CORRECT - Programmatic navigation -->
  <v-btn @click="navigateToEdit(questionnaire.id)">Edit</v-btn>
</template>
```

#### Inertia Form Handling
```vue
<script setup>
import { useForm } from '@inertiajs/vue3'

const form = useForm({
  title: '',
  description: '',
  questions: []
})

function submit() {
  form.post(route('questionnaire.admin.store'), {
    onSuccess: () => { /* Handle success */ },
    onError: (errors) => { /* Handle validation errors */ }
  })
}
</script>

<template>
  <v-form @submit.prevent="submit">
    <v-text-field
      v-model="form.title"
      :error-messages="form.errors.title"
      label="Title"
    />
    <v-btn type="submit" :loading="form.processing">Save</v-btn>
  </v-form>
</template>
```

### 7.5 Vuetify & Material Design Guidelines

**Rule**: Use Vuetify components exclusively. Follow Material Design 3 principles.

#### Component Selection
```vue
<!-- ❌ WRONG - Raw HTML -->
<button class="btn">Click</button>
<input type="text" />

<!-- ✅ CORRECT - Vuetify components -->
<v-btn>Click</v-btn>
<v-text-field />
```

#### Material Design Principles
| Principle | Implementation |
|-----------|----------------|
| **Elevation** | Use `elevation` prop for depth hierarchy |
| **Color System** | Use theme colors (`primary`, `secondary`, `error`) |
| **Typography** | Use `text-h1` to `text-body-2` classes |
| **Spacing** | Use Vuetify spacing (`ma-4`, `pa-2`, `mt-3`) |
| **Motion** | Use Vuetify transitions (`v-fade-transition`) |

#### Layout Patterns
```vue
<template>
  <!-- Use Vuetify grid system -->
  <v-container>
    <v-row>
      <v-col cols="12" md="6">
        <v-card elevation="2">
          <v-card-title class="text-h5">Title</v-card-title>
          <v-card-text>Content</v-card-text>
          <v-card-actions>
            <v-spacer />
            <v-btn color="primary">Action</v-btn>
          </v-card-actions>
        </v-card>
      </v-col>
    </v-row>
  </v-container>
</template>
```

#### Theme Configuration (`vuetify.js`)
```javascript
import { createVuetify } from 'vuetify'

export default createVuetify({
  theme: {
    defaultTheme: 'light',
    themes: {
      light: {
        colors: {
          primary: '#1976D2',
          secondary: '#424242',
          accent: '#82B1FF',
          error: '#FF5252',
          success: '#4CAF50',
          warning: '#FFC107',
        }
      }
    }
  },
  defaults: {
    VBtn: { variant: 'flat', color: 'primary' },
    VTextField: { variant: 'outlined', density: 'comfortable' },
    VCard: { elevation: 2 }
  }
})
```

### 7.6 Composables Pattern

**Rule**: Extract reusable logic into `Composables/` directory.

```typescript
// Composables/useQuestionnaire.ts
import { ref, computed } from 'vue'
import { router } from '@inertiajs/vue3'

export function useQuestionnaire(initialData?: Questionnaire) {
  const questionnaire = ref(initialData)
  const loading = ref(false)
  const error = ref<string | null>(null)

  const isPublished = computed(() => 
    questionnaire.value?.status === 'published'
  )

  async function publish() {
    loading.value = true
    router.post(
      route('questionnaire.admin.publish', questionnaire.value?.id),
      {},
      {
        onSuccess: () => { loading.value = false },
        onError: (e) => { error.value = e.message; loading.value = false }
      }
    )
  }

  return {
    questionnaire,
    loading,
    error,
    isPublished,
    publish
  }
}
```

#### Composable Naming Convention
| Pattern | Example |
|---------|---------|
| State management | `useQuestionnaire`, `useResponses` |
| Form handling | `useQuestionForm`, `useValidation` |
| UI utilities | `useDialog`, `useSnackbar`, `useConfirm` |
| Data fetching | `useFetchQuestions`, `useAsyncData` |

### 7.7 State Management

#### Local State (Preferred for most cases)
```vue
<script setup>
import { ref, reactive, computed } from 'vue'

const count = ref(0)
const form = reactive({ title: '', description: '' })
const isValid = computed(() => form.title.length > 0)
</script>
```

#### Pinia (For complex global state)
```typescript
// stores/questionnaireStore.ts
import { defineStore } from 'pinia'

export const useQuestionnaireStore = defineStore('questionnaire', {
  state: () => ({
    drafts: [] as Questionnaire[],
    currentId: null as number | null
  }),
  
  getters: {
    currentDraft: (state) => 
      state.drafts.find(d => d.id === state.currentId)
  },
  
  actions: {
    saveDraft(data: Partial<Questionnaire>) {
      // Implementation
    }
  }
})
```

### 7.8 TypeScript Integration

**Rule**: Use TypeScript for type safety in `.vue` and `.ts` files.

```typescript
// types/questionnaire.ts
export interface Questionnaire {
  id: number
  title: string
  description: string | null
  status: 'draft' | 'published' | 'closed' | 'archived'
  questions: Question[]
  created_at: string
  updated_at: string
}

export interface Question {
  id: number
  type: QuestionType
  content: string
  options: string[] | null
  settings: QuestionSettings
  order: number
}

export type QuestionType = 
  | 'text' 
  | 'textarea' 
  | 'radio' 
  | 'checkbox' 
  | 'select' 
  | 'number' 
  | 'date'
```

### 7.9 Accessibility (a11y)

**Rule**: Ensure WCAG AA compliance.

```vue
<template>
  <!-- Use semantic HTML within Vuetify -->
  <v-main>
    <v-container tag="main" role="main">
      <!-- Proper labeling -->
      <v-text-field
        v-model="email"
        label="Email Address"
        aria-describedby="email-hint"
        :aria-invalid="!!errors.email"
      />
      <div id="email-hint" class="text-caption">
        We'll never share your email.
      </div>
      
      <!-- Focus management for dialogs -->
      <v-dialog v-model="dialog" aria-labelledby="dialog-title">
        <v-card>
          <v-card-title id="dialog-title">Confirm Action</v-card-title>
        </v-card>
      </v-dialog>
    </v-container>
  </v-main>
</template>
```

#### Accessibility Checklist
- [ ] All interactive elements are keyboard accessible
- [ ] Focus is managed for modals and dynamic content
- [ ] Color contrast meets WCAG AA (4.5:1 for text)
- [ ] Images have meaningful `alt` text
- [ ] Form inputs have associated labels
- [ ] Error messages are announced to screen readers

### 7.10 Performance Optimization

```vue
<script setup>
import { defineAsyncComponent } from 'vue'

// Lazy-load heavy components
const QuestionEditor = defineAsyncComponent(() => 
  import('./Components/QuestionEditor.vue')
)
</script>

<template>
  <!-- Use v-once for static content -->
  <v-card-title v-once>{{ staticTitle }}</v-card-title>
  
  <!-- Use v-memo for expensive renders -->
  <div v-memo="[questionnaire.id]">
    <ExpensiveComponent :data="questionnaire" />
  </div>
  
  <!-- Suspense for async components -->
  <Suspense>
    <template #default>
      <QuestionEditor />
    </template>
    <template #fallback>
      <v-skeleton-loader type="card" />
    </template>
  </Suspense>
</template>
```

### 7.11 Error Handling

```vue
<script setup>
import { onErrorCaptured } from 'vue'

// Local error boundary
onErrorCaptured((error, instance, info) => {
  console.error('Component error:', error)
  // Report to error tracking service
  return false // Prevent propagation
})
</script>
```

#### Global Error Handler (in `index.js`)
```javascript
app.config.errorHandler = (err, instance, info) => {
  console.error('Global error:', err)
  // Send to Sentry/LogRocket
}
```

### 7.12 Page Overriding Support

**Rule**: Host applications can override package pages.

```javascript
// index.js
import { createInertiaApp } from '@inertiajs/vue3'

createInertiaApp({
  resolve: async (name) => {
    // 1. Try host app pages first
    const hostPages = import.meta.glob('/resources/js/Pages/**/*.vue')
    if (hostPages[`/resources/js/Pages/${name}.vue`]) {
      return (await hostPages[`/resources/js/Pages/${name}.vue`]()).default
    }
    
    // 2. Fallback to package pages
    const packagePages = import.meta.glob('./Pages/**/*.vue')
    return (await packagePages[`./Pages/${name}.vue`]()).default
  },
  // ...
})
```

---

## 8. Code Style Checklist

Before committing, verify:

### Backend (PHP/Laravel)
- [ ] `declare(strict_types=1);` at top of every PHP file
- [ ] All new classes have corresponding interfaces (if swappable)
- [ ] Actions receive DTOs, not arrays
- [ ] Enums used instead of magic strings
- [ ] Models resolved from config, not hardcoded
- [ ] Dependencies injected via interfaces
- [ ] Events fired before/after major operations
- [ ] PHPDoc on all public methods

### Frontend (Vue/Inertia/Vuetify)
- [ ] `<script setup lang="ts">` syntax used
- [ ] Vuetify components used (no raw HTML for UI elements)
- [ ] Inertia `router` used for navigation (no vue-router)
- [ ] TypeScript interfaces for props and data shapes
- [ ] Composables extracted for reusable logic
- [ ] Material Design spacing/elevation/color conventions followed
- [ ] Accessibility attributes present (labels, aria, roles)
- [ ] Form errors displayed via `:error-messages` binding

---

## 9. Quick Reference

### Interface -> Implementation Mapping

| Interface | Default Implementation |
|-----------|----------------------|
| `QuestionnaireRepositoryInterface` | `EloquentQuestionnaireRepository` |
| `ResponseRepositoryInterface` | `EloquentResponseRepository` |
| `QuestionTypeRegistryInterface` | `QuestionTypeManager` |
| `ValidationStrategyInterface` | `DefaultValidationStrategy` |
| `CreateQuestionnaireActionInterface` | `CreateQuestionnaireAction` |
| `UpdateQuestionnaireActionInterface` | `UpdateQuestionnaireAction` |
| `PublishQuestionnaireActionInterface` | `PublishQuestionnaireAction` |
| `CloseQuestionnaireActionInterface` | `CloseQuestionnaireAction` |
| `SubmitResponseActionInterface` | `SubmitResponseAction` |
| `ExporterInterface` | `CsvExporter` |
| `DuplicateSubmissionGuardInterface` | Via Factory |

### Config Keys

| Key | Purpose |
|-----|---------|
| `questionnaire.models.*` | Swap Eloquent models |
| `questionnaire.bindings.*` | Swap repositories/services |
| `questionnaire.actions.*` | Swap action classes |
| `questionnaire.controllers.*` | Swap controllers |
| `questionnaire.policies.*` | Swap authorization policies |
| `questionnaire.question_types` | Register question types |
| `questionnaire.duplicate_guards` | Register submission guards |
